<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	  <meta name="author" content="{{ site.author }}" />
    <meta name="description" content="{{ site.description }}">
    <link rel="favicon" href="{{ site.baseurl }}static/img/favicon.ico?v=3">
    <link rel="icon" type="image/png" href="{{ site.baseurl }}static/img/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="{{ site.baseurl }}static/img/favicon-16x16.png" sizes="16x16" />
    <!-- Generator https://manytools.org/http-html-text/apple-touch-icon-generator/ -->
    <link rel="apple-touch-icon" href="{{ site.baseurl }}static/img/touch-icons/apple-touch-icon-iphone-60x60.png">
    <link rel="apple-touch-icon" sizes="60x60" href="{{ site.baseurl }}static/img/touch-icons/apple-touch-icon-ipad-76x76">
    <link rel="apple-touch-icon" sizes="114x114" href="{{ site.baseurl }}static/img/touch-icons/apple-touch-icon-iphone-retina-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="{{ site.baseurl }}static/img/touch-icons/apple-touch-icon-ipad-retina-152x152.png">
    <link rel="manifest" href="/manifest.json">

    <!--
      Lots of issues with PWAs on Safari iOS, use web applications
      https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/ConfiguringWebApplications/ConfiguringWebApplications.html
      Bugs:
      https://medium.com/@firt/pwas-are-coming-to-ios-11-3-cupertino-we-have-a-problem-2ff49fd7d6ea
      https://medium.com/@firt/progressive-web-apps-on-ios-are-here-d00430dee3a7

    -->

    {% if page.title %}
      <title>{{ page.title }}</title>
    {% else %}
      <title>{{ site.title }}</title>
    {% endif %}

    <link rel="stylesheet" type="text/css" href="{{ site.baseurl }}static/css/main.css" />

  <style>
    @media all and (display-mode: standalone) {
      .mynav {
        border-top: none;
      }
      footer {
        border-bottom: none;
      }
    }
  </style>

  <script>
    // Optimize loading perf - https://developers.google.com/web/fundamentals/primers/service-workers/registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }


    function urlBase64ToUint8Array(base64String) {
      var padding = '='.repeat((4 - base64String.length % 4) % 4);
      var base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');

      var rawData = window.atob(base64);
      var outputArray = new Uint8Array(rawData.length);

      for (var i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
  }


    function displayNotification() {
      if (Notification.permission === 'granted') {
        navigator.serviceWorker.ready.then(function(registration) {
          /*registration.showNotification('Conference Alert!!!', {
            body: 'Check out where Chris will be speaking next...',
            icon: 'static/img/icons/icon-144x144.png',
            vibrate: [200, 100, 200, 100, 200, 100, 200],
            tag: 'vibration-sample'
          });
          */
          registration.pushManager.getSubscription().then(function(sub) {
            console.log(sub);
            if (sub === null) {
              // Update UI to ask user to register for Push
              console.log('Not subscribed to push service!');
            } else {
              // We have a subscription, update the database
              console.log('p256dh: ', sub.getKey('p256dh'));
              console.log('Auth: ', sub.getKey('auth'));
              console.log('Subscription object: ', sub);
            }
          });

           registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array(
                'BMml6nfim9qV3ETjXWWRPs1e7VG0wVhbiqdjEBWqdEB4HAfGLljuSzqlmG3Bp-iRfnS224P-mqd-G0TpCebcqyw'
              )
            }).then(function(sub) {
              console.log('Endpoint URL: ', sub.endpoint);
            }).catch(function(e) {
              if (Notification.permission === 'denied') {
                console.warn('Permission for notifications was denied');
              } else {
                console.error('Unable to subscribe to push', e);
              }
            });
        });
        // navigator.serviceWorker.getRegistration().then(function(reg) {
        //   var options = {
        //     body: 'Here is a notification body!',
        //     icon: 'static/img/icons/icon-144x144.png',
        //     vibrate: [100, 50, 100],
        //     data: {
        //       dateOfArrival: Date.now(),
        //       primaryKey: 1
        //     },
        //     actions: [
        //       {action: 'explore', title: 'Explore this new world',
        //         icon: 'static/img/icons/icon-144x144.png'},
        //       {action: 'close', title: 'Close notification',
        //         icon: 'static/img/icons/icon-144x144.png'},
        //     ]
        //   };
        //   reg.showNotification('Hello world!', options);
        // });
      } else {
        Notification.requestPermission(function(status) {
            console.log('Notification permission status:', status);
        });
      }
    }

    displayNotification();

    function sendNotification(endpoint) {
      var notification = {
        'title': 'Portugal vs. Denmark',
        'body': '5 to 1',
        'icon': 'static/img/icons/icon-144x144.png',
        'click_action': 'https://www.chiefhacker.com/speaking.html'
      };

      fetch(endpoint, {
        'method': 'POST',
        'headers': {
          'Content-Type': 'application/json'
        },
        'body': JSON.stringify({
          data: {
            'notification': notification,
          }
        })
      }).then(function(response) {
        console.log(response);
      }).catch(function(error) {
        console.error(error);
      })
    }

    //PWAs can detect network status!!
    function updateOnlineStatus(event) {
      let profileImg = document.getElementById('profileImg');
      let src = profileImg.src;

      profileImg.src = navigator.onLine ? src.replace('_offline', '') : src.replace('.jpg', '_offline.jpg');
    }

    window.addEventListener('online',  updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
  </script>

    <!-- Google Analytics -->
    {% include analytics.html %}
  </head>
  <body>
    {% include header.html %}

    {{ content }}
  <footer></footer>
  </body>
</html>
